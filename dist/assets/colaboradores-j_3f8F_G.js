import{c as $e}from"./index-DnGFXnjs.js";import"./preload-helper-BxaVoaJg.js";const Ge="https://tzbqdjwgbisntzljwbqp.supabase.co",ze="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6YnFkandnYmlzbnR6bGp3YnFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTQyNTUsImV4cCI6MjA3MTk5MDI1NX0.fl0GBdHF_Pc56FSCVkKmCrCQANMVGvQ8sKLDoqK7eAQ",f=$e(Ge,ze);let c={colaboradoresData:[],dadosFiltrados:[],filtrosAtivos:{},serviceMatrizMap:new Map};const P=50;let N=P,I,y,v,K,z,k,ae,W,h,A,w,oe,D,U,H,q,j,X,m={},p=null,le,G,Me,de,ce,Y,C=null,V,F,ne,L,M,_,b=null,ee=!1;function Te(e){return String(e||"").replace(/\D/g,"")||null}function Be(e){return typeof e=="string"?e.toUpperCase():e}function O(e){return typeof e=="string"?e.toUpperCase().trim():e}function S(e){if(e==null)return null;const t=String(e).trim();return t===""?null:t}function be(e){const t=S(e);if(t===null)return null;const a=Number(t);return Number.isFinite(a)?a:null}function R(e){const t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),t.getDate()).getTime()}function re(e){if(!e)return"";const[t,a,o]=String(e).split("-");return`${o}/${a}/${t}`}function se(){if(!h||h.dataset.upperBound==="1")return;h.dataset.upperBound="1";const e=a=>{a.addEventListener("input",()=>{const o=a.selectionStart,n=a.selectionEnd,r=Be(a.value);if(a.value!==r){a.value=r;try{a.setSelectionRange(o,n)}catch{}}}),a.addEventListener("blur",()=>{a.value=O(a.value)})};h.querySelectorAll('input[type="text"], input[type="search"], input[type="email"], input[type="tel"], input:not([type]), textarea').forEach(e),h.querySelectorAll("select").forEach(a=>{a.style.textTransform="uppercase"})}function ke(e){if(!e||e.dataset.upperBound==="1")return;e.dataset.upperBound="1",e.querySelectorAll('input[type="text"], input[type="search"], input[type="email"], input[type="tel"], input:not([type]), textarea').forEach(a=>{a.addEventListener("input",()=>{const[o,n]=[a.selectionStart,a.selectionEnd],r=Be(a.value);if(a.value!==r){a.value=r;try{a.setSelectionRange(o,n)}catch{}}}),a.addEventListener("blur",()=>{a.value=O(a.value)})}),e.querySelectorAll("select").forEach(a=>{a.style.textTransform="uppercase"})}function Ve(e){const t=new Set(["Data de admissão","Data de nascimento"]),a={};for(const[o,n]of Object.entries(e)){if(n==null){a[o]=null;continue}if(o==="LDAP"){a[o]=S(n);continue}if(t.has(o)){a[o]=S(n);continue}if(typeof n=="string"){const r=O(n);a[o]=r===""?null:r}else a[o]=n}return a}function Ue(e){if(I){if(I.innerHTML="",!e||e.length===0){I.innerHTML='<tr><td colspan="10" class="text-center p-4">Nenhum colaborador encontrado.</td></tr>';return}e.forEach(t=>{const a=document.createElement("tr");a.setAttribute("data-nome",t.Nome||""),a.innerHTML=`<td class="nome-col">${t.Nome||""}</td>
      <td>${t.Contrato||""}</td>
      <td>${t.Cargo||""}</td>
      <td>${t["Data de admissão"]?new Date(t["Data de admissão"]).toLocaleDateString("pt-BR",{timeZone:"UTC"}):""}</td>
      <td>${t.Escala||""}</td>
      <td>${t.DSR||""}</td>
      <td>${t.SVC||""}</td>
      <td>${t.LDAP||""}</td>
      <td>${t["ID GROOT"]||""}</td>
      <td>${t["FOLGA ESPECIAL"]||""}</td>`,I.appendChild(a)})}}function ie(){const e=c.dadosFiltrados.slice(0,N);Ue(e),k&&k.classList.toggle("hidden",N<=P),z&&z.classList.toggle("hidden",N>=c.dadosFiltrados.length),ae&&(ae.textContent=`${e.length} de ${c.dadosFiltrados.length} colaboradores visíveis`)}function He(){if(!v)return;const e={Contrato:new Set,Cargo:new Set,Escala:new Set,DSR:new Set,MATRIZ:new Set,SVC:new Set,"FOLGA ESPECIAL":new Set};c.colaboradoresData.forEach(t=>{Object.keys(e).forEach(a=>{t[a]&&e[a].add(String(t[a]))})}),v.forEach(t=>{const a=t.dataset.filterKey;if(!a||!(a in e))return;const o=Array.from(e[a]).sort((n,r)=>n.localeCompare(r,"pt-BR"));for(;t.options.length>1;)t.remove(1);o.forEach(n=>{const r=document.createElement("option");r.value=n,r.textContent=n,t.appendChild(r)})})}function Z(){const e=((y==null?void 0:y.value)||"").toLowerCase();c.dadosFiltrados=c.colaboradoresData.filter(t=>{for(const a in c.filtrosAtivos)if(Object.prototype.hasOwnProperty.call(c.filtrosAtivos,a)&&c.filtrosAtivos[a]&&String(t[a])!==c.filtrosAtivos[a])return!1;return e?String(t.Nome||"").toLowerCase().includes(e)||String(t.CPF||"").toLowerCase().includes(e)||String(t["ID GROOT"]||"").toLowerCase().includes(e)||String(t.LDAP||"").toLowerCase().includes(e):!0}),N=P,ie()}async function T(){I&&(I.innerHTML='<tr><td colspan="10" class="text-center p-4">Carregando...</td></tr>');const{data:e,error:t}=await f.from("Colaboradores").select("*").order("Nome");if(t){console.error("Erro ao carregar colaboradores:",t),I&&(I.innerHTML='<tr><td colspan="10" class="text-center p-4 text-red-500">Erro ao carregar dados.</td></tr>');return}c.colaboradoresData=e||[],He(),Z()}async function qe(){const e=document.getElementById("addSVC");if(!e||c.serviceMatrizMap.size>0&&e.options.length>1)return;const{data:t,error:a}=await f.from("Matrizes").select("SERVICE, MATRIZ");if(a){console.error("Erro ao buscar mapa de serviço-matriz:",a),e.innerHTML='<option value="" disabled selected>Erro ao carregar</option>';return}c.serviceMatrizMap=new Map((t||[]).map(o=>[String(o.SERVICE||"").toUpperCase(),o.MATRIZ||""])),e.innerHTML='<option value="" disabled selected>Selecione um SVC...</option>',(t||[]).sort((o,n)=>String(o.SERVICE).localeCompare(String(n.SERVICE))).forEach(o=>{const n=document.createElement("option");n.value=String(o.SERVICE||"").toUpperCase(),n.textContent=String(o.SERVICE||"").toUpperCase(),e.appendChild(n)})}async function je(e){var g,x,$,ue,me,fe,Ee,pe,ge,Se,Ce,ye,Ie,De,ve,he,we,Fe;e.preventDefault(),se();const t=((g=document.getElementById("addNome"))==null?void 0:g.value)||"",a=((x=document.getElementById("addCPF"))==null?void 0:x.value)||"",o=Te(a),n=O(t);if(!n){alert("Informe o NOME do colaborador."),($=document.getElementById("addNome"))==null||$.focus();return}const{count:r,error:l}=await f.from("Colaboradores").select("Nome",{count:"exact",head:!0}).ilike("Nome",n);if(l){alert(`Erro ao validar nome: ${l.message}`);return}if((r||0)>0){alert("Já existe um colaborador com esse NOME."),(ue=document.getElementById("addNome"))==null||ue.focus();return}if(o){const{count:xe,error:Ne}=await f.from("Colaboradores").select("CPF",{count:"exact",head:!0}).eq("CPF",o);if(Ne){alert(`Erro ao validar CPF: ${Ne.message}`);return}if((xe||0)>0){alert("Já existe um colaborador com esse CPF."),(me=document.getElementById("addCPF"))==null||me.focus();return}}const i=((fe=document.getElementById("addGenero"))==null?void 0:fe.value)||"",d=S(i);if(!d){alert("Selecione o GÊNERO."),(Ee=document.getElementById("addGenero"))==null||Ee.focus();return}const u=Ve({Nome:n,CPF:o,"Data de nascimento":((pe=document.getElementById("addDataNascimento"))==null?void 0:pe.value)||null,Genero:d,Contrato:((ge=document.getElementById("addContrato"))==null?void 0:ge.value)||"",Cargo:((Se=document.getElementById("addCargo"))==null?void 0:Se.value)||"",Gestor:((Ce=document.getElementById("addGestor"))==null?void 0:Ce.value)||"",DSR:S((ye=document.getElementById("addDSR"))==null?void 0:ye.value),Escala:S((Ie=document.getElementById("addEscala"))==null?void 0:Ie.value),"Data de admissão":((De=document.getElementById("addDataAdmissao"))==null?void 0:De.value)||null,SVC:S((ve=document.getElementById("addSVC"))==null?void 0:ve.value),MATRIZ:S((he=document.getElementById("addMatriz"))==null?void 0:he.value),LDAP:S((we=document.getElementById("addLDAP"))==null?void 0:we.value),"ID GROOT":be((Fe=document.getElementById("addIdGroot"))==null?void 0:Fe.value),Ativo:"SIM",Ferias:"NAO","Total Presença":0,"Total Faltas":0,"Total Atestados":0,"Total Suspensões":0}),{error:E}=await f.from("Colaboradores").insert([u]);if(E){alert(`Erro ao adicionar colaborador: ${E.message}`);return}alert("Colaborador adicionado com sucesso!"),document.dispatchEvent(new CustomEvent("colaborador-added")),await T()}async function Xe(){if(!D||c.serviceMatrizMap.size>0&&D.options.length>1)return;const{data:e,error:t}=await f.from("Matrizes").select("SERVICE, MATRIZ");if(t){console.error(t);return}c.serviceMatrizMap=new Map((e||[]).map(a=>[String(a.SERVICE||"").toUpperCase(),a.MATRIZ||""])),D.innerHTML='<option value="" disabled selected>Selecione...</option>',(e||[]).sort((a,o)=>String(a.SERVICE).localeCompare(String(o.SERVICE))).forEach(a=>{const o=document.createElement("option"),n=String(a.SERVICE||"").toUpperCase();o.value=n,o.textContent=n,D.appendChild(o)})}async function te(e){const{data:t,error:a}=await f.from("Colaboradores").select("*").eq("Nome",e).maybeSingle();if(a)throw a;return t}function Ye(){A==null||A.classList.remove("hidden")}function J(){A==null||A.classList.add("hidden"),p=null,w==null||w.reset()}async function _e(e){p={Nome:e.Nome,CPF:e.CPF??null};const t=(o,n)=>{o&&(o.value=n??"")};oe&&(oe.textContent=e.Nome||"Colaborador"),t(m.Nome,e.Nome||""),t(m.CPF,e.CPF||""),t(m.Contrato,e.Contrato||""),t(m.Cargo,e.Cargo||""),t(m.Gestor,e.Gestor||""),t(m.DSR,e.DSR||""),t(m.Escala,e.Escala||""),t(m["FOLGA ESPECIAL"],e["FOLGA ESPECIAL"]||""),t(m.LDAP,e.LDAP??""),t(m["ID GROOT"],e["ID GROOT"]??"");const a=e["Data de nascimento"]?new Date(e["Data de nascimento"]).toISOString().split("T")[0]:"";if(t(m["Data de nascimento"],a),D){const o=e.SVC?String(e.SVC).toUpperCase():"";if(o&&!Array.from(D.options).some(n=>n.value===o)){const n=document.createElement("option");n.value=o,n.textContent=o,D.appendChild(n)}D.value=o||""}}async function Ze(e){if(e.Nome&&e.Nome!==p.Nome){const{count:t,error:a}=await f.from("Colaboradores").select("Nome",{count:"exact",head:!0}).ilike("Nome",e.Nome).neq("Nome",p.Nome);if(a)throw a;if((t||0)>0)return"Já existe um colaborador com esse NOME."}if(e.CPF){const{count:t,error:a}=await f.from("Colaboradores").select("CPF",{count:"exact",head:!0}).eq("CPF",e.CPF).neq("Nome",p.Nome);if(a)throw a;if((t||0)>0)return"Já existe um colaborador com esse CPF."}return null}async function Je(e){e.preventDefault();const t=O(m.Nome.value||"");if(!t){alert("Informe o NOME."),m.Nome.focus();return}const a=Te(m.CPF.value||""),o=S(D.value),n=o&&c.serviceMatrizMap.get(String(o).toUpperCase())||null,r={Nome:t,CPF:a,Contrato:m.Contrato.value||"",Cargo:m.Cargo.value||"",Gestor:S(m.Gestor.value),DSR:S(m.DSR.value),Escala:S(m.Escala.value),"FOLGA ESPECIAL":S(m["FOLGA ESPECIAL"].value),LDAP:S(m.LDAP.value),"ID GROOT":be(m["ID GROOT"].value),"Data de nascimento":m["Data de nascimento"].value||null,SVC:o,MATRIZ:n};Object.keys(r).forEach(d=>{typeof r[d]=="string"&&d!=="LDAP"&&(r[d]=O(r[d]))});const l=await Ze(r);if(l){alert(l);return}const{error:i}=await f.from("Colaboradores").update(r).eq("Nome",p.Nome);if(i){alert(`Erro ao atualizar: ${i.message}`);return}alert("Colaborador atualizado com sucesso!"),document.dispatchEvent(new CustomEvent("colaborador-edited",{detail:{nomeAnterior:p.Nome,nomeAtual:r.Nome}})),J()}function Qe(e,t){if(!e)return"0";const a=new Date(e),o=new Date(t);if(isNaN(a.getTime()))return"0";const n=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()),r=Date.UTC(o.getFullYear(),o.getMonth(),o.getDate()),l=Math.floor((r-n)/(1e3*60*60*24));if(l<0)return"Data inválida";if(l===0)return"0";if(l<=15)return`${l} dia(s)`;let i=(o.getFullYear()-a.getFullYear())*12;i-=a.getMonth(),i+=o.getMonth();const d=Math.floor(i/12),u=i%12;return i<1?"Menos de 1 mês":i<2?"1 mês":d>0?u>0?`${d} ano(s) e ${u} mes(es)`:`${d} ano(s)`:`${i} mes(es)`}function Ke(e){C=e,Me.value=(e==null?void 0:e.Nome)||"";const t=new Date,a=n=>String(n).padStart(2,"0"),o=`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}`;de.value=o,ce.selectedIndex=0,le.classList.remove("hidden")}function Pe(){le.classList.add("hidden"),C=null,G.reset()}async function We(e){if(e.preventDefault(),!C){alert("Erro: colaborador não carregado.");return}const t=de.value,a=ce.value;if(!t){alert("Informe a data de desligamento.");return}if(!a){alert("Selecione o motivo.");return}const o=Qe(C["Data de admissão"],t),n={Nome:C.Nome||null,Contrato:C.Contrato||null,Cargo:C.Cargo||null,"Data de Admissão":C["Data de admissão"]||null,Gestor:C.Gestor||null,"Data de Desligamento":t,"Período Trabalhado":o,Escala:C.Escala||null,SVC:C.SVC||null,MATRIZ:C.MATRIZ||null,Motivo:a||null},{error:r}=await f.from("Desligados").insert([n]);if(r){alert(`Erro ao registrar em Desligados: ${r.message}`);return}const{error:l}=await f.from("Colaboradores").delete().eq("Nome",C.Nome);if(l){alert(`Erro ao remover de Colaboradores: ${l.message}`);return}alert("Colaborador desligado com sucesso!"),Pe(),J(),await T()}async function et(e){const{data:t,error:a}=await f.from("Ferias").select("*").eq("Nome",e).eq("Status","Em andamento").order("Numero",{ascending:!1}).limit(1);return a?{error:a}:{data:t&&t[0]?t[0]:null}}async function tt(e){const{colaborador:t,dataInicio:a,dataFinal:o}=e,{data:n}=await et(t.Nome);if(n)return{error:new Error('Este colaborador já está com férias "Em andamento". Finalize antes de iniciar novas férias.')};const{data:r,error:l}=await f.from("Ferias").select("Numero").order("Numero",{ascending:!1}).limit(1);if(l)return{error:l};const i=r&&r.length>0?r[0].Numero+1:1,d=R(new Date),u=R(a),E=R(o),g=d<u?"A iniciar":d<=E?"Em andamento":"Finalizado",x={Numero:i,Nome:t.Nome,Escala:t.Escala,SVC:t.SVC,"Data Inicio":a,"Data Final":o,Status:g,"Dias para finalizar":Math.max(0,Math.ceil((E-d)/(1e3*60*60*24)))},{error:$}=await f.from("Ferias").insert([x]);return $?{error:$}:(await at(),{success:!0})}async function at(){const{data:e,error:t}=await f.from("Ferias").select("*").order("Numero",{ascending:!0});if(t||!e)return;const a=R(new Date);for(const o of e){const n=R(o["Data Inicio"]),r=R(o["Data Final"]);let l=o.Status,i={};if(o.Status==="Finalizado")o["Dias para finalizar"]!==0&&(i["Dias para finalizar"]=0),await f.from("Colaboradores").update({Ferias:"NAO"}).eq("Nome",o.Nome);else{a>r?l="Finalizado":a>=n&&a<=r?l="Em andamento":a<n&&(l="A iniciar");const d=Math.max(0,Math.ceil((r-a)/(1e3*60*60*24)));(l!==o.Status||d!==o["Dias para finalizar"])&&(i.Status=l,i["Dias para finalizar"]=d,l==="Em andamento"?await f.from("Colaboradores").update({Ferias:"SIM"}).eq("Nome",o.Nome):l==="Finalizado"&&await f.from("Colaboradores").update({Ferias:"NAO"}).eq("Nome",o.Nome))}Object.keys(i).length>0&&await f.from("Ferias").update(i).eq("Numero",o.Numero)}}function ot(e){if(b=e,!V)return;ne&&(ne.value=(e==null?void 0:e.Nome)||"");const t=new Date,a=n=>String(n).padStart(2,"0"),o=`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())}`;L&&!L.value&&(L.value=o),M&&!M.value&&(M.value=o),V.classList.remove("hidden")}function Re(){V&&(V.classList.add("hidden"),b=null,F==null||F.reset())}async function nt(e){if(e.preventDefault(),!ee){ee=!0;try{if(!b||!b.Nome){alert("Erro: dados do colaborador não carregados.");return}const t=((L==null?void 0:L.value)||"").trim(),a=((M==null?void 0:M.value)||"").trim();if(!t||!a){alert("Selecione a Data de Início e a Data Final.");return}const o=new Date(t),n=new Date(a);if(isNaN(o)||isNaN(n)){alert("Datas inválidas. Verifique os campos.");return}if(n<o){alert("A Data Final não pode ser anterior à Data de Início.");return}if(!confirm(`Confirmar férias de ${b.Nome} de ${re(t)} até ${re(a)}?`))return;const{success:l,error:i}=await tt({colaborador:b,dataInicio:t,dataFinal:a});if(!l){alert(`Erro ao agendar férias: ${(i==null?void 0:i.message)||i}`);return}alert("Férias agendadas com sucesso!"),Re(),await T()}finally{ee=!1}}}const s={nome:null,ano:new Date().getFullYear(),marks:new Map,dsrDates:new Set,initialized:!1,els:{modal:null,title:null,yearSel:null,months:null,fecharBtn:null}},rt=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],Ae={PRESENCA:"st-presenca",FALTA:"st-falta",ATESTADO:"st-atestado",F_ESPECIAL:"st-fe",FERIADO:"st-feriado",SUSPENSAO:"st-susp",DSR:"st-dsr"},st={PRESENCA:"Presença",FALTA:"Falta",ATESTADO:"Atestado",F_ESPECIAL:"Folga Especial",FERIADO:"Feriado",SUSPENSAO:"Suspensão",DSR:"DSR"},Q=e=>e<10?`0${e}`:`${e}`,it=(e,t)=>new Date(e,t+1,0).getDate(),lt=(e,t)=>{const a=new Date(e,t,1).getDay();return a===0?6:a-1},dt=(e,t,a)=>`${e}-${Q(t+1)}-${Q(a)}`,B=e=>e===1||e==="1"||e===!0||String(e).toUpperCase()==="SIM";function ct(){var o;if(s.initialized)return;if(s.els.modal=document.getElementById("historicoModal"),s.els.title=document.getElementById("hist-title"),s.els.yearSel=document.getElementById("hist-year"),s.els.months=document.getElementById("months"),s.els.fecharBtn=document.getElementById("historicoFecharBtn"),!s.els.modal||!s.els.title||!s.els.yearSel||!s.els.months){console.warn("Histórico: elementos do modal não encontrados.");return}const e=2023,t=2030;s.els.yearSel.innerHTML="";for(let n=e;n<=t;n++){const r=document.createElement("option");r.value=String(n),r.textContent=String(n),s.els.yearSel.appendChild(r)}const a=new Date().getFullYear();s.ano=Math.max(e,Math.min(t,a)),s.els.yearSel.value=String(s.ano),s.els.yearSel.addEventListener("change",async()=>{s.ano=parseInt(s.els.yearSel.value,10),await Oe()}),(o=s.els.fecharBtn)==null||o.addEventListener("click",()=>{s.els.modal.classList.add("hidden")}),document.addEventListener("keydown",n=>{n.key==="Escape"&&!s.els.modal.classList.contains("hidden")&&s.els.modal.classList.add("hidden")}),s.initialized=!0}function ut(){s.els.title&&(s.els.title.textContent=s.nome?`Histórico – ${s.nome}`:"Histórico")}function mt(){const e=s.els.months;if(e){e.innerHTML="";for(let t=0;t<12;t++){const a=document.createElement("div");a.className="month-card";const o=document.createElement("div");o.className="month-title",o.textContent=rt[t]+" "+s.ano,a.appendChild(o);const n=document.createElement("div");n.className="dow",["S","T","Q","Q","S","S","D"].forEach(d=>{const u=document.createElement("div");u.textContent=d,n.appendChild(u)}),a.appendChild(n);const r=document.createElement("div");r.className="days";const l=lt(s.ano,t);for(let d=0;d<l;d++){const u=document.createElement("div");u.className="day blank",r.appendChild(u)}const i=it(s.ano,t);for(let d=1;d<=i;d++){const u=document.createElement("div");u.className="day",u.textContent=d;const E=dt(s.ano,t,d);let g=s.marks.get(E);!g&&s.dsrDates&&s.dsrDates.has(E)&&(g="DSR"),g&&Ae[g]?(u.classList.add(Ae[g]),u.title=`${E} – ${st[g]}`):u.title=E,r.appendChild(u)}a.appendChild(r),e.appendChild(a)}}}async function ft(e,t){try{const{data:a,error:o}=await f.from("Colaboradores").select("DSR").eq("Nome",e).maybeSingle();if(o)throw o;const n=String((a==null?void 0:a.DSR)||"").toUpperCase();if(!n)return new Set;const l={SEGUNDA:0,TERÇA:1,TERCA:1,QUARTA:2,QUINTA:3,SEXTA:4,SABADO:5,SÁBADO:5,DOMINGO:6}[n]??null;if(l==null)return new Set;const i=new Set,d=new Date(t,0,1),u=new Date(t,11,31);for(let E=new Date(d);E<=u;E.setDate(E.getDate()+1)){const g=E.getDay();(g===0?6:g-1)===l&&i.add(`${E.getFullYear()}-${Q(E.getMonth()+1)}-${Q(E.getDate())}`)}return i}catch(a){return console.error("computeDsrDatesForYear error:",a),new Set}}async function Oe(){if(s.nome){s.els.months&&(s.els.months.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:10px;color:#6b7280;">Carregando…</div>');try{const e=Number.isInteger(s.ano)?s.ano:new Date().getFullYear(),t=`${e}-01-01`,a=`${e}-12-31`,{data:o,error:n}=await f.from("ControleDiario").select('Data, "Presença", Falta, Atestado, "Folga Especial", Feriado, Suspensao').eq("Nome",s.nome).gte("Data",t).lte("Data",a).order("Data",{ascending:!0});if(n){console.error("getHistoricoPresencas erro:",n),s.els.months&&(s.els.months.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:10px;color:#e55353;">Erro ao carregar histórico.</div>');return}s.marks.clear(),(o||[]).forEach(r=>{const l=r.Data;let i=null;B(r.Presença)?i="PRESENCA":B(r.Falta)?i="FALTA":B(r.Atestado)?i="ATESTADO":B(r["Folga Especial"])?i="F_ESPECIAL":B(r.Feriado)?i="FERIADO":B(r.Suspensao)&&(i="SUSPENSAO"),i&&s.marks.set(l,i)}),s.dsrDates=await ft(s.nome,e),mt()}catch(e){console.error("Falha geral ao carregar histórico:",e),s.els.months&&(s.els.months.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:10px;color:#e55353;">Erro ao carregar histórico.</div>')}}}async function Et(e){if(ct(),!s.els.modal){alert("Não foi possível abrir o histórico (elementos do modal não encontrados).");return}if(s.nome=e||null,s.els.yearSel){const t=new Date().getFullYear();s.els.yearSel.value||(s.els.yearSel.value=String(t)),s.ano=parseInt(s.els.yearSel.value||t,10)||t}ut(),await Oe(),s.els.modal.classList.remove("hidden")}function pt(){var a,o;A=document.getElementById("editModal"),w=document.getElementById("editForm"),oe=document.getElementById("editTitulo"),D=document.getElementById("editSVC"),U=document.getElementById("editExcluirBtn"),H=document.getElementById("editCancelarBtn"),document.getElementById("editSalvarBtn"),q=document.getElementById("editDesligarBtn"),j=document.getElementById("editFeriasBtn"),X=document.getElementById("editHistoricoBtn"),m={Nome:document.getElementById("editNome"),CPF:document.getElementById("editCPF"),Contrato:document.getElementById("editContrato"),Cargo:document.getElementById("editCargo"),Gestor:document.getElementById("editGestor"),DSR:document.getElementById("editDSR"),Escala:document.getElementById("editEscala"),"FOLGA ESPECIAL":document.getElementById("editFolgaEspecial"),LDAP:document.getElementById("editLDAP"),"ID GROOT":document.getElementById("editIdGroot"),"Data de nascimento":document.getElementById("editDataNascimento")};const e=document.getElementById("editMatriz");e&&((a=e.closest(".form-row")||e.parentElement)==null||a.classList.add("hidden"));const t=document.getElementById("editGestor");t&&((o=t.closest(".form-row")||t.parentElement)==null||o.classList.remove("hidden")),ke(w),w==null||w.addEventListener("submit",Je),H==null||H.addEventListener("click",J),U==null||U.addEventListener("click",async()=>{if(!p||!confirm("Tem certeza que deseja excluir este colaborador?"))return;const{error:r}=await f.from("Colaboradores").delete().eq("Nome",p.Nome);if(r){alert(`Erro ao excluir: ${r.message}`);return}alert("Colaborador excluído com sucesso!"),document.dispatchEvent(new CustomEvent("colaborador-deleted",{detail:{nome:p.Nome}})),J(),await T()}),q==null||q.addEventListener("click",async()=>{if(!p)return;const n=await te(p.Nome);if(!n){alert("Colaborador não encontrado.");return}Ke(n)}),j==null||j.addEventListener("click",async()=>{if(!p)return;const n=await te(p.Nome);if(!n){alert("Colaborador não encontrado.");return}ot(n)}),X==null||X.addEventListener("click",()=>{p!=null&&p.Nome&&Et(p.Nome)}),document.addEventListener("open-edit-modal",async n=>{var l;const r=(l=n.detail)==null?void 0:l.nome;if(r)try{await Xe();const i=await te(r);if(!i){alert("Colaborador não encontrado.");return}await _e(i),Ye()}catch(i){console.error(i),alert("Erro ao carregar colaborador para edição.")}})}function gt(){le=document.getElementById("desligarModal"),G=document.getElementById("desligarForm"),Me=document.getElementById("desligarNome"),de=document.getElementById("desligarData"),ce=document.getElementById("desligarMotivo"),Y=document.getElementById("desligarCancelarBtn"),Y==null||Y.addEventListener("click",Pe),G==null||G.addEventListener("submit",We)}function St(){V=document.getElementById("feriasModal")||null,F=document.getElementById("feriasForm")||document.getElementById("ferias-form")||null,ne=document.getElementById("feriasNome")||document.getElementById("nome-colaborador")||null,L=document.getElementById("feriasDataInicio")||document.getElementById("data-inicio")||null,M=document.getElementById("feriasDataFinal")||document.getElementById("data-final")||null,_=document.getElementById("feriasCancelarBtn")||document.getElementById("cancelarBtn")||null,_==null||_.addEventListener("click",Re),F==null||F.addEventListener("submit",nt)}async function Ct(){window.XLSX||await new Promise((e,t)=>{const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",a.onload=e,a.onerror=()=>t(new Error("Falha ao carregar biblioteca XLSX")),document.head.appendChild(a)})}function Le(e){const t=o=>o??"",a=o=>o?re(String(o)):"";return{Nome:t(e.Nome),CPF:t(e.CPF),"Data de nascimento":a(e["Data de nascimento"]),Gênero:t(e.Genero),Contrato:t(e.Contrato),Cargo:t(e.Cargo),Gestor:t(e.Gestor),DSR:t(e.DSR),Escala:t(e.Escala),"Data de admissão":a(e["Data de admissão"]),SVC:t(e.SVC),MATRIZ:t(e.MATRIZ),LDAP:t(e.LDAP),"ID GROOT":e["ID GROOT"]??"","FOLGA ESPECIAL":t(e["FOLGA ESPECIAL"]),Ativo:t(e.Ativo),Férias:t(e.Ferias),"Total Presença":e["Total Presença"]??"","Total Faltas":e["Total Faltas"]??"","Total Atestados":e["Total Atestados"]??"","Total Suspensões":e["Total Suspensões"]??""}}async function yt(e){const t=e?c.dadosFiltrados:c.colaboradoresData;if(!t||t.length===0){alert("Não há dados para exportar.");return}await Ct();const a=t.map(Le),o=Object.keys(Le({})),n=window.XLSX.utils.book_new(),r=window.XLSX.utils.json_to_sheet(a,{header:o}),l=o.map(u=>{const E=Math.max(u.length,...a.map(g=>String(g[u]??"").length));return{wch:Math.min(Math.max(10,E+2),40)}});r["!cols"]=l,window.XLSX.utils.book_append_sheet(n,r,"Colaboradores");const i=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-"),d=e?"filtrado":"completo";window.XLSX.writeFile(n,`colaboradores-${d}-${i}.xlsx`)}async function vt(e,t){try{const{data:a,error:o}=await f.from("Ferias").select('Nome, Escala, SVC, "Data Inicio"').gte("Data Inicio",e).lte("Data Inicio",t).order("Data Inicio",{ascending:!0}).order("Nome",{ascending:!0});return o?{error:o}:{data:a||[]}}catch(a){return{error:a}}}function ht(){if(I=document.getElementById("colaboradores-tbody"),y=document.getElementById("search-input"),v=document.querySelectorAll(".filters select"),K=document.getElementById("limpar-filtros-btn"),W=document.getElementById("add-colaborador-btn"),z=document.getElementById("mostrar-mais-btn"),k=document.getElementById("mostrar-menos-btn"),ae=document.getElementById("contador-visiveis"),h=document.getElementById("addForm"),T(),y&&y.addEventListener("input",Z),v&&v.length&&v.forEach(t=>{t.addEventListener("change",a=>{const o=t.dataset.filterKey,n=a.target.value;n?c.filtrosAtivos[o]=n:delete c.filtrosAtivos[o],Z()})}),K&&K.addEventListener("click",()=>{y&&(y.value=""),v&&v.length&&v.forEach(t=>t.selectedIndex=0),c.filtrosAtivos={},Z()}),z&&z.addEventListener("click",()=>{N+=P,ie()}),k&&k.addEventListener("click",()=>{N=Math.max(P,N-P),ie()}),W&&W.addEventListener("click",()=>{qe(),se(),document.dispatchEvent(new CustomEvent("open-add-modal"))}),h){se(),h.addEventListener("submit",je);const t=document.getElementById("addSVC"),a=document.getElementById("addMatriz");t&&a&&t.addEventListener("change",()=>{a.value=c.serviceMatrizMap.get(String(t.value))||""})}I&&(I.addEventListener("dblclick",t=>{var o;const a=(o=t.target.closest("tr"))==null?void 0:o.dataset.nome;a&&document.dispatchEvent(new CustomEvent("open-edit-modal",{detail:{nome:a}}))}),document.addEventListener("colaborador-edited",async()=>{await T()}),document.addEventListener("colaborador-deleted",async()=>{await T()}));const e=document.getElementById("export-colaboradores-btn");e&&e.addEventListener("click",async()=>{if(!c.colaboradoresData.length){alert("Não há dados para exportar.");return}const t=!!(y&&y.value&&y.value.trim()!==""),a=Object.keys(c.filtrosAtivos).length>0,o=c.dadosFiltrados.length!==c.colaboradoresData.length,n=t||a||o;e.disabled=!0;try{await yt(n)}catch(r){console.error(r),alert("Falha ao exportar. Tente novamente.")}finally{e.disabled=!1}}),pt(),gt(),St()}export{vt as getFeriasRange,ht as init};
